<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>maph: Maph Architecture Documentation</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">maph<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">High-Performance Memory-Mapped Key-Value Database with O(1) Lookups</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d6/d41/md_docs_2_a_r_c_h_i_t_e_c_t_u_r_e.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Maph Architecture Documentation</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md145"></a> </p>
<h1><a class="anchor" id="autotoc_md146"></a>
Table of Contents</h1>
<ul>
<li>Overview</li>
<li>System Design</li>
<li>Memory Layout</li>
<li>Perfect Hash Function</li>
<li>Collision Handling</li>
<li>Concurrency Model</li>
<li>Performance Optimizations</li>
<li>Storage Tiers</li>
<li>Durability and Persistence</li>
</ul>
<h1><a class="anchor" id="autotoc_md147"></a>
Overview</h1>
<p>Maph (Memory-mapped Approximate Perfect Hash) is a high-performance key-value database that combines memory-mapped I/O with approximate perfect hashing to achieve sub-microsecond lookups. The system is designed for read-heavy workloads where lookup performance is critical.</p>
<h2><a class="anchor" id="autotoc_md148"></a>
Key Design Goals</h2>
<ul>
<li><b>Ultra-fast lookups</b>: O(1) average case, typically &lt; 1µs</li>
<li><b>Zero-copy operations</b>: Direct memory access via string_view</li>
<li><b>Persistence</b>: Automatic durability through mmap</li>
<li><b>Simplicity</b>: Single-file database, no external dependencies</li>
<li><b>Scalability</b>: Support for billions of key-value pairs</li>
</ul>
<h1><a class="anchor" id="autotoc_md149"></a>
System Design</h1>
<h2><a class="anchor" id="autotoc_md150"></a>
Architecture Layers</h2>
<div class="fragment"><div class="line">┌─────────────────────────────────────────┐</div>
<div class="line">│         Application Layer               │</div>
<div class="line">│   (REST API, CLI, Client Libraries)     │</div>
<div class="line">├─────────────────────────────────────────┤</div>
<div class="line">│           Maph Core API                 │</div>
<div class="line">│  (get, set, remove, batch operations)   │</div>
<div class="line">├─────────────────────────────────────────┤</div>
<div class="line">│         Hash Function Layer             │</div>
<div class="line">│    (FNV-1a, SIMD optimization)          │</div>
<div class="line">├─────────────────────────────────────────┤</div>
<div class="line">│        Storage Management               │</div>
<div class="line">│   (Slot allocation, version control)    │</div>
<div class="line">├─────────────────────────────────────────┤</div>
<div class="line">│      Memory-Mapped I/O (mmap)           │</div>
<div class="line">│    (OS page cache, virtual memory)      │</div>
<div class="line">├─────────────────────────────────────────┤</div>
<div class="line">│          File System                    │</div>
<div class="line">│      (Persistent storage)               │</div>
<div class="line">└─────────────────────────────────────────┘</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md151"></a>
Component Interactions</h2>
<ol type="1">
<li><b>Client Request</b>: Application makes a get/set request</li>
<li><b>Hash Computation</b>: Key is hashed using FNV-1a algorithm</li>
<li><b>Slot Location</b>: Hash determines slot index via modulo</li>
<li><b>Memory Access</b>: Direct memory read/write via mmap</li>
<li><b>OS Sync</b>: Operating system handles page cache and disk sync</li>
</ol>
<h1><a class="anchor" id="autotoc_md152"></a>
Memory Layout</h1>
<p>The database file consists of a header followed by a fixed array of slots:</p>
<div class="fragment"><div class="line">┌────────────────┐</div>
<div class="line">│   Header       │ 512 bytes</div>
<div class="line">│   (Metadata)   │</div>
<div class="line">├────────────────┤</div>
<div class="line">│   Slot 0       │ 512 bytes</div>
<div class="line">├────────────────┤</div>
<div class="line">│   Slot 1       │ 512 bytes</div>
<div class="line">├────────────────┤</div>
<div class="line">│      ...       │</div>
<div class="line">├────────────────┤</div>
<div class="line">│   Slot N-1     │ 512 bytes</div>
<div class="line">└────────────────┘</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md153"></a>
Header Structure (512 bytes)</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Size   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">magic   </td><td class="markdownTableBodyNone">4 bytes   </td><td class="markdownTableBodyNone">File format identifier (0x4D415048 = "MAPH")    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">version   </td><td class="markdownTableBodyNone">4 bytes   </td><td class="markdownTableBodyNone">Database format version    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">total_slots   </td><td class="markdownTableBodyNone">8 bytes   </td><td class="markdownTableBodyNone">Total number of slots    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">static_slots   </td><td class="markdownTableBodyNone">8 bytes   </td><td class="markdownTableBodyNone">Number of perfect hash slots    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">generation   </td><td class="markdownTableBodyNone">8 bytes   </td><td class="markdownTableBodyNone">Global modification counter    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">reserved   </td><td class="markdownTableBodyNone">480 bytes   </td><td class="markdownTableBodyNone">Future extensions   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md154"></a>
Slot Structure (512 bytes)</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Size   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">hash_version   </td><td class="markdownTableBodyNone">8 bytes   </td><td class="markdownTableBodyNone">Atomic 64-bit: hash (32) + version (32)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">size   </td><td class="markdownTableBodyNone">4 bytes   </td><td class="markdownTableBodyNone">Value data size    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">reserved   </td><td class="markdownTableBodyNone">4 bytes   </td><td class="markdownTableBodyNone">Future use    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">data   </td><td class="markdownTableBodyNone">496 bytes   </td><td class="markdownTableBodyNone">Actual value storage   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md155"></a>
Memory Alignment</h2>
<ul>
<li>Slots are 64-byte aligned for optimal CPU cache line usage</li>
<li>Atomic operations on hash_version prevent torn reads/writes</li>
<li>Data layout minimizes false sharing between threads</li>
</ul>
<h1><a class="anchor" id="autotoc_md156"></a>
Perfect Hash Function</h1>
<h2><a class="anchor" id="autotoc_md157"></a>
FNV-1a Algorithm</h2>
<p>The system uses FNV-1a (Fowler-Noll-Vo) hash function for its simplicity and good distribution:</p>
<div class="fragment"><div class="line">uint32_t fnv1a(<span class="keyword">const</span> <span class="keywordtype">char</span>* data, <span class="keywordtype">size_t</span> len) {</div>
<div class="line">    uint32_t hash = 2166136261u;  <span class="comment">// FNV offset basis</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; len; i++) {</div>
<div class="line">        hash ^= data[i];</div>
<div class="line">        hash *= 16777619u;  <span class="comment">// FNV prime</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> hash;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md158"></a>
Hash Properties</h2>
<ul>
<li><b>Distribution</b>: Excellent avalanche effect</li>
<li><b>Speed</b>: Single pass, minimal operations</li>
<li><b>Collision Rate</b>: ~1/2³² for random keys</li>
<li><b>SIMD Support</b>: AVX2 implementation for batch operations</li>
</ul>
<h2><a class="anchor" id="autotoc_md159"></a>
Slot Index Calculation</h2>
<div class="fragment"><div class="line">slot_index = hash % total_slots</div>
</div><!-- fragment --><p>For static slots (perfect hashing region):</p><ul>
<li>Direct mapping: one slot per unique hash</li>
<li>No collision handling needed</li>
<li>Single memory access for lookups</li>
</ul>
<h1><a class="anchor" id="autotoc_md160"></a>
Collision Handling</h1>
<p>The database uses a two-tier approach:</p>
<h2><a class="anchor" id="autotoc_md161"></a>
Static Slots (Default: 80% of total)</h2>
<ul>
<li><b>Perfect hashing</b>: Each key maps to exactly one slot</li>
<li><b>No collisions</b>: Overwrites on hash collision</li>
<li><b>Use case</b>: Known key sets, unique identifiers</li>
</ul>
<h2><a class="anchor" id="autotoc_md162"></a>
Dynamic Slots (Default: 20% of total)</h2>
<ul>
<li><b>Linear probing</b>: Search up to MAX_PROBE_DISTANCE (10) slots</li>
<li><b>Collision resolution</b>: Find next empty slot</li>
<li><b>Use case</b>: General-purpose storage, unknown key sets</li>
</ul>
<h2><a class="anchor" id="autotoc_md163"></a>
Probing Strategy</h2>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; MAX_PROBE_DISTANCE; i++) {</div>
<div class="line">    uint32_t idx = (base_index + i) % total_slots;</div>
<div class="line">    <span class="keywordflow">if</span> (slots[idx].empty() || slots[idx].hash() == target_hash) {</div>
<div class="line">        <span class="comment">// Found target slot</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md164"></a>
Concurrency Model</h1>
<h2><a class="anchor" id="autotoc_md165"></a>
Thread Safety Guarantees</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Operation   </th><th class="markdownTableHeadNone">Thread Safety   </th><th class="markdownTableHeadNone">Notes    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">get()   </td><td class="markdownTableBodyNone">✅ Safe   </td><td class="markdownTableBodyNone">Lock-free reads via atomic operations    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">set()   </td><td class="markdownTableBodyNone">⚠️ Unsafe   </td><td class="markdownTableBodyNone">Requires external synchronization    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">remove()   </td><td class="markdownTableBodyNone">⚠️ Unsafe   </td><td class="markdownTableBodyNone">Requires external synchronization    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">scan()   </td><td class="markdownTableBodyNone">✅ Safe   </td><td class="markdownTableBodyNone">Read-only operation    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">parallel_*   </td><td class="markdownTableBodyNone">✅ Safe   </td><td class="markdownTableBodyNone">Internal thread management   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md166"></a>
Atomic Operations</h2>
<p>The <code>hash_version</code> field uses atomic operations for consistency:</p>
<ol type="1">
<li><b>Version Increment</b>: Odd version = updating, Even version = stable</li>
<li><b>Double-Write Pattern</b>:<ul>
<li>Write hash with version+1 (mark as updating)</li>
<li>Copy data</li>
<li>Write hash with version+2 (mark as complete)</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md167"></a>
Lock-Free Reads</h2>
<p>Readers can safely access slots without locks:</p><ul>
<li>Atomic load of hash_version</li>
<li>Check version parity (skip if odd/updating)</li>
<li>Read data if version is stable (even)</li>
</ul>
<h1><a class="anchor" id="autotoc_md168"></a>
Performance Optimizations</h1>
<h2><a class="anchor" id="autotoc_md169"></a>
CPU Cache Optimization</h2>
<ul>
<li><b>64-byte alignment</b>: Fits exactly one cache line</li>
<li><b>Prefetching</b>: Batch operations prefetch future slots</li>
<li><b>Hot/cold separation</b>: Metadata separate from data</li>
</ul>
<h2><a class="anchor" id="autotoc_md170"></a>
SIMD Acceleration</h2>
<ul>
<li><b>AVX2 batch hashing</b>: Process 8 keys in parallel</li>
<li><b>Automatic detection</b>: Runtime CPU feature detection</li>
<li><b>Fallback</b>: Scalar implementation for compatibility</li>
</ul>
<h2><a class="anchor" id="autotoc_md171"></a>
Memory Access Patterns</h2>
<ul>
<li><b>Sequential scanning</b>: Predictable access for prefetcher</li>
<li><b>Spatial locality</b>: Related data in same cache line</li>
<li><b>Temporal locality</b>: Version check before data access</li>
</ul>
<h2><a class="anchor" id="autotoc_md172"></a>
Zero-Copy Design</h2>
<ul>
<li><b>string_view returns</b>: No allocation for reads</li>
<li><b>Direct memory access</b>: Values read from mmap'd memory</li>
<li><b>In-place updates</b>: Writes directly to mapped region</li>
</ul>
<h1><a class="anchor" id="autotoc_md173"></a>
Storage Tiers</h1>
<h2><a class="anchor" id="autotoc_md174"></a>
Tier 1: CPU Cache (L1/L2/L3)</h2>
<ul>
<li><b>Latency</b>: 1-10 ns</li>
<li><b>Size</b>: MB range</li>
<li><b>Usage</b>: Hot slots, frequently accessed</li>
</ul>
<h2><a class="anchor" id="autotoc_md175"></a>
Tier 2: RAM (Page Cache)</h2>
<ul>
<li><b>Latency</b>: 50-100 ns</li>
<li><b>Size</b>: GB range</li>
<li><b>Usage</b>: Active working set</li>
</ul>
<h2><a class="anchor" id="autotoc_md176"></a>
Tier 3: Disk (SSD/HDD)</h2>
<ul>
<li><b>Latency</b>: 10-100 µs (SSD), 1-10 ms (HDD)</li>
<li><b>Size</b>: TB range</li>
<li><b>Usage</b>: Full database, cold data</li>
</ul>
<p>The OS transparently manages data movement between tiers via the page cache.</p>
<h1><a class="anchor" id="autotoc_md177"></a>
Durability and Persistence</h1>
<h2><a class="anchor" id="autotoc_md178"></a>
Automatic Persistence</h2>
<ul>
<li><b>mmap semantics</b>: Changes visible immediately in memory</li>
<li><b>OS page cache</b>: Buffers writes, flushes periodically</li>
<li><b>Crash consistency</b>: OS ensures atomic page writes</li>
</ul>
<h2><a class="anchor" id="autotoc_md179"></a>
Explicit Durability Options</h2>
<ol type="1">
<li><b>sync()</b>: Request async flush to disk (MS_ASYNC)</li>
<li><b>sync_now()</b>: Force synchronous flush (MS_SYNC)</li>
<li><b>DurabilityManager</b>: Background thread for periodic sync</li>
</ol>
<h2><a class="anchor" id="autotoc_md180"></a>
Recovery Semantics</h2>
<ul>
<li><b>No journal/WAL</b>: Direct updates to data file</li>
<li><b>Atomic slots</b>: Each slot update is atomic</li>
<li><b>Version checking</b>: Detect incomplete updates</li>
</ul>
<h2><a class="anchor" id="autotoc_md181"></a>
Best Practices</h2>
<ul>
<li>Enable durability for critical data</li>
<li>Use sync_now() before shutdown</li>
<li>Monitor generation counter for change detection</li>
</ul>
<h1><a class="anchor" id="autotoc_md182"></a>
Design Trade-offs</h1>
<h2><a class="anchor" id="autotoc_md183"></a>
Advantages</h2>
<ul>
<li><b>Simplicity</b>: Single file, no complex structures</li>
<li><b>Performance</b>: Sub-microsecond lookups</li>
<li><b>Zero maintenance</b>: No compaction, no garbage collection</li>
<li><b>OS integration</b>: Leverages OS page cache effectively</li>
</ul>
<h2><a class="anchor" id="autotoc_md184"></a>
Limitations</h2>
<ul>
<li><b>Fixed slot size</b>: 496 bytes maximum value</li>
<li><b>No compression</b>: Values stored as-is</li>
<li><b>Limited transactions</b>: No ACID guarantees</li>
<li><b>Hash collisions</b>: Possible data loss in static region</li>
</ul>
<h2><a class="anchor" id="autotoc_md185"></a>
When to Use Maph</h2>
<p>✅ <b>Good fit for:</b></p><ul>
<li>Read-heavy workloads</li>
<li>Known value size bounds</li>
<li>Cache/session storage</li>
<li>High-frequency lookups</li>
<li>Fixed datasets</li>
</ul>
<p>❌ <b>Not ideal for:</b></p><ul>
<li>Large values (&gt;496 bytes)</li>
<li>Complex queries</li>
<li>Strong consistency requirements</li>
<li>Frequent updates to same keys</li>
<li>Unknown/unbounded datasets</li>
</ul>
<h1><a class="anchor" id="autotoc_md186"></a>
Future Enhancements</h1>
<h2><a class="anchor" id="autotoc_md187"></a>
Planned Improvements</h2>
<ul>
<li><b>Cuckoo hashing</b>: Better collision handling</li>
<li><b>Compression</b>: Value compression support</li>
<li><b>Sharding</b>: Multi-file databases</li>
<li><b>Replication</b>: Master-slave support</li>
<li><b>Transactions</b>: Basic MVCC support</li>
</ul>
<h2><a class="anchor" id="autotoc_md188"></a>
Research Areas</h2>
<ul>
<li><b>Learned indexes</b>: ML-based hash functions</li>
<li><b>Persistent memory</b>: Intel Optane support</li>
<li><b>RDMA</b>: Remote memory access</li>
<li><b>GPU acceleration</b>: CUDA/OpenCL hashing </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Sep 4 2025 01:57:37 for maph by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
